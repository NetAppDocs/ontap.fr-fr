---
sidebar: sidebar 
permalink: upgrade/task_upgrade_andu_cli.html 
keywords: netapp, ontap, automate, automatic, automated, upgrade, nondisruptive, nondisruptively, non-disruptive update, nondisruptive upgrade, upgrade a cluster, shift workload between clusters, hardware platform, configuration, software image, update, update ONTAP, update software, ndu 
summary: Vous pouvez mettre à jour la version de ONTAP sur votre cluster sans interruption. 
---
= Mise à niveau automatisée et sans interruption d'ONTAP à l'aide de l'interface de ligne
:hardbreaks:
:toclevels: 1
:allow-uri-read: 
:toclevels: 1
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
Pour les mises à niveau automatisées, ONTAP installe automatiquement l'image ONTAP cible sur chaque nœud, valide les composants du cluster afin de s'assurer qu'il peut être mis à niveau sans interruption, puis exécute une xref:concept_upgrade_methods.html[mise à niveau par lot ou déploiement] en arrière-plan basé sur le nombre de nœuds.

Vous pouvez utiliser l'interface de ligne de commande pour vérifier que le cluster peut être mis à niveau sans interruption, installer l'image ONTAP cible sur chaque nœud, puis exécuter une mise à niveau en arrière-plan.


NOTE: Si vous ne prévoyez pas de suivre la progression du processus de mise à niveau, il est conseillé de le faire link:task_requesting_notification_of_issues_encountered_in_nondisruptive_upgrades.html["Demandez des notifications EMS d'erreurs susceptibles de nécessiter une intervention manuelle"].

.Avant de commencer
* Vous devriez link:prepare.html["préparez votre mise à niveau"].
* Vous devriez link:download-software-image.html["Téléchargez l'image du logiciel ONTAP"] Pour votre version cible de ONTAP.
* Pour chaque paire haute disponibilité, chaque nœud doit avoir un ou plusieurs ports sur le même broadcast domain.
+
Si vous avez 8 nœuds ou plus, la méthode de mise à niveau par lot est utilisée dans la mise à niveau automatique sans interruption.  Dans ONTAP 9.7 et version antérieure, si la méthode de traitement par lots est utilisée, les LIF sont migrées vers le partenaire de haute disponibilité du nœud mis à niveau.  Si les partenaires ne disposent d'aucun port dans le même broadcast domain, alors la migration LIF échoue.

+
Dans ONTAP 9.8 et version ultérieure, si la méthode de traitement par lots est utilisée, les LIF sont migrées vers l'autre groupe de batchs.

* Si vous exécutez un link:https://docs.netapp.com/us-en/ontap/upgrade/concept_upgrade_paths.html#types-of-upgrade-paths["mise à niveau directe à plusieurs sauts"], Vous devez avoir obtenu les deux images ONTAP requises pour votre spécifique link:https://docs.netapp.com/us-en/ontap/upgrade/concept_upgrade_paths.html#supported-upgrade-paths["chemin de mise à niveau"].
* Si vous mettez à niveau ONTAP dans une configuration MetroCluster FC, le cluster doit être activé en vue du basculement automatique non planifié.



NOTE: Modification du paramètre de l' `storage failover modify-auto-giveback` L'option de commande avant le début d'une mise à niveau automatique sans interruption (ANDU) n'a aucun impact sur le processus de mise à niveau. Le processus ANDU ignore toute valeur prédéfinie à cette option lors du basculement/retour requis pour la mise à jour. Par exemple, paramètre `-autogiveback` À false avant de commencer ANDU n'interrompt pas la mise à jour automatique avant le retour.



== Étape 1 : chargez l'image du logiciel ONTAP cible dans le référentiel de package de cluster

Pour lancer le processus de mise à niveau du logiciel ONTAP, vous devez rendre l'image du logiciel ONTAP cible disponible dans le référentiel du pack de cluster.

.Étapes
. Supprimez le pack logiciel ONTAP précédent :
+
[source, cli]
----
cluster image package delete -version previous_ONTAP_Version
----
. Charger l'image logicielle ONTAP cible dans le référentiel de packages de clusters :
+
[source, cli]
----
cluster image package get -url location
----
+
[listing]
----
cluster1::> cluster image package get -url http://www.example.com/software/9.13.1/image.tgz

Package download completed.
Package processing completed.
----
+
Si vous exécutez un link:https://docs.netapp.com/us-en/ontap/upgrade/concept_upgrade_paths.html#types-of-upgrade-paths["mise à niveau directe à plusieurs sauts"], Vous devez également charger le progiciel pour la version intermédiaire de ONTAP requise pour votre mise à niveau. Par exemple, si vous effectuez une mise à niveau de 9.8 vers 9.13.1, vous devez charger le progiciel pour ONTAP 9.12.1, puis utiliser la même commande pour charger le progiciel pour 9.13.1.

. Vérifiez que le pack logiciel est disponible dans le référentiel du package de cluster :
+
[source, cli]
----
cluster image package show-repository
----
+
[listing]
----
cluster1::> cluster image package show-repository
Package Version  Package Build Time
---------------- ------------------
9.13.1              MM/DD/YYYY 10:32:15
----




== Étape 2 : exécution de vérifications automatisées préalables à la mise à niveau

Avant d'effectuer une mise à niveau automatisée de votre logiciel ONTAP, vous pouvez également utiliser `cluster image validate` commande permettant de vérifier que le cluster peut être mis à niveau correctement.  Le `cluster image validate` la commande exécute une série de contrôles sur les composants du cluster, puis fournit une liste des validations spécifiques réalisées et une liste des actions correctives à entreprendre avant de poursuivre la mise à niveau.

. Exécuter les vérifications automatiques préalables à la mise à niveau :
+
[source, cli]
----
cluster image validate -version package_version_number
----
+
** Si vous exécutez un link:https://docs.netapp.com/us-en/ontap/upgrade/concept_upgrade_paths.html#types-of-upgrade-paths["mise à niveau directe à plusieurs sauts"],Utiliser le paquet ONTAP cible pour la vérification.  Il n'est pas nécessaire de valider séparément l'image de mise à niveau intermédiaire.  Par exemple, si vous effectuez une mise à niveau de 9.8 vers 9.13.1, vous devez utiliser le package 9.13.1 pour la vérification. Il n'est pas nécessaire de valider le package 9.12.1 séparément.
** Si vous mettez à niveau une configuration MetroCluster à deux ou quatre nœuds, vous devez exécuter cette commande sur les deux clusters avant de poursuivre.
+
[listing]
----
cluster1::> cluster image validate -version 9.13.1

WARNING: There are additional manual upgrade validation checks that must be performed after these automated validation checks have completed...
----


. Surveiller la progression de la validation :
+
[source, cli]
----
cluster image show-update-progress
----
. Effectuez toutes les actions requises identifiées par la validation.




== Étape 3 : mise à niveau du logiciel ONTAP

. Générer une estimation de mise à niveau logicielle :
+
[source, cli]
----
cluster image update -version package_version_number -estimate-only
----
+
L'estimation de la mise à niveau logicielle affiche des détails sur chaque composant à mettre à jour, ainsi que la durée estimée de la mise à niveau.

. Effectuez la mise à niveau logicielle :
+
[source, cli]
----
cluster image update -version package_version_number
----
+
** Si vous exécutez un link:https://docs.netapp.com/us-en/ontap/upgrade/concept_upgrade_paths.html#types-of-upgrade-paths["mise à niveau directe à plusieurs sauts"], Utilisez la version ONTAP cible pour le numéro_version_paquet. Par exemple, si vous effectuez une mise à niveau de ONTAP 9.8 vers 9.13.1, utilisez 9.13.1 comme numéro_version_paquet.
** Si le cluster comprend entre 2 et 6 nœuds, une mise à niveau est effectuée. Si le cluster comprend au moins 8 nœuds, une mise à niveau par lot est effectuée par défaut. Si vous le souhaitez, vous pouvez utiliser le `-force-rolling` paramètre pour spécifier une mise à niveau par roulement à la place.
** À l'issue de chaque basculement et rétablissement, la mise à niveau attend 8 minutes pour que les applications client puissent restaurer les données après la pause des E/S qui a lieu lors du basculement et du rétablissement. Si votre environnement nécessite plus ou moins de temps pour la stabilisation du client, vous pouvez utiliser le `-stabilize-minutes` paramètre pour spécifier une durée de stabilisation différente.
** Dans le cas de n'importe quelle configuration MetroCluster, à l'exception d'un système MetroCluster à 2 nœuds, le processus de mise à niveau de la baie ONTAP démarre simultanément sur les paires haute disponibilité de chaque site (le site local et le site de reprise après incident) une fois que l'utilisateur démarre et fournit une confirmation sur la ligne de commande. Sur un système MetroCluster à 2 nœuds, la mise à jour commence en premier sur le site de reprise sur incident, c'est-à-dire sur lequel la mise à niveau n'est pas initiée. Une fois la mise à jour terminée à fond sur le site de reprise d'activité, la mise à niveau commence sur le site local.
+
[listing]
----
cluster1::> cluster image update -version 9.13.1

Starting validation for this update. Please wait..

It can take several minutes to complete validation...

WARNING: There are additional manual upgrade validation checks...

Pre-update Check      Status     Error-Action
--------------------- ---------- --------------------------------------------
...
20 entries were displayed

Would you like to proceed with update ? {y|n}: y
Starting update...

cluster-1::>
----


. Afficher la progression de la mise à jour du cluster :
+
[source, cli]
----
cluster image show-update-progress
----
+
Si vous mettez à niveau une configuration MetroCluster à 4 ou 8 nœuds, le `cluster image show-update-progress` commande uniquement affiche la progression du nœud sur lequel vous exécutez la commande. Vous devez exécuter la commande sur chaque nœud pour voir la progression de chaque nœud.

. Vérifiez que la mise à niveau a été effectuée correctement sur chaque nœud.
+
[source, cli]
----
cluster image show-update-progress
----
+
[listing]
----
cluster1::> cluster image show-update-progress

                                             Estimated         Elapsed
Update Phase         Status                   Duration        Duration
-------------------- ----------------- --------------- ---------------
Pre-update checks    completed                00:10:00        00:02:07
Data ONTAP updates   completed                01:31:00        01:39:00
Post-update checks   completed                00:10:00        00:02:00
3 entries were displayed.

Updated nodes: node0, node1.
----
. Déclencher une notification AutoSupport :
+
[source, cli]
----
autosupport invoke -node * -type all -message "Finishing_NDU"
----
+
Si votre cluster n'est pas configuré pour envoyer des messages AutoSupport, une copie de la notification est enregistrée localement.

. Vérifier que le cluster est activé pour le basculement automatique non planifié :
+

NOTE: Cette étape s'effectue uniquement pour les configurations MetroCluster FC.  Si vous utilisez une configuration IP MetroCluster, vous n'avez pas besoin d'effectuer cette étape.

+
.. Vérifier si le basculement automatique non planifié est activé :
+
[source, cli]
----
metrocluster show
----
+
Si le basculement automatique non planifié est activé, l'instruction suivante apparaît dans la sortie de la commande :

+
....
AUSO Failure Domain    auso-on-cluster-disaster
....
.. Si l'instruction n'apparaît pas dans la sortie, activez le basculement automatique non planifié :
+
[source, cli]
----
metrocluster modify -auto-switchover-failure-domain auso-on-cluster-disaster -overide-vetoes true
----
+

NOTE: Vous ne pouvez pas effectuer le rétablissement tant que la mise à niveau automatisée sans interruption n'est pas terminée.

.. Vérifier que le basculement automatique non planifié a été activé :
+
[source, cli]
----
metrocluster show
----




.Informations associées
* https://aiq.netapp.com/["Lancez Active IQ"]
* https://docs.netapp.com/us-en/active-iq/["Documentation Active IQ"]

